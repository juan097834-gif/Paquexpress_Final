from fastapi import FastAPI, HTTPException, UploadFile, File, Form
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import mysql.connector
import os
from datetime import datetime
import shutil
import bcrypt

app = FastAPI()

# Configuración de Seguridad
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], 
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

os.makedirs("evidencias", exist_ok=True)
app.mount("/evidencias", StaticFiles(directory="evidencias"), name="evidencias")

def get_db_connection():
    return mysql.connector.connect(host="localhost", user="root", password="", database="paquexpress", port=3306)

# Funciones de Hashing
def hash_password(password: str) -> str:
    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
    return hashed.decode('utf-8')

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return bcrypt.checkpw(plain_password.encode('utf-8'), hashed_password.encode('utf-8'))

class LoginModel(BaseModel):
    username: str
    password: str

class RegisterModel(BaseModel):
    username: str
    password: str
    nombre: str

@app.post("/register")
def register(data: RegisterModel):
    hashed_pw = hash_password(data.password) 
    
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        sql = "INSERT INTO agentes (username, password, nombre) VALUES (%s, %s, %s)"
        cursor.execute(sql, (data.username, hashed_pw, data.nombre))
        conn.commit()
        
        # Asignar paquetes de prueba al nuevo usuario
        new_user_id = cursor.lastrowid
        
        # --- AQUÍ AGREGAMOS LA UBICACIÓN DE QUERÉTARO ---
        paquetes_demo = [
            # Monterrey
            ('Tec de Monterrey', 'Rectoría', '25.6514', '-100.2900', new_user_id),
            # Monterrey
            ('Macroplaza', 'Turismo', '25.6691', '-100.3099', new_user_id),
            # QUERÉTARO (Los Arcos)
            ('Los Arcos, Querétaro', 'Centro Histórico', '20.5937', '-100.3755', new_user_id) 
        ]
        
        cursor.executemany("INSERT INTO paquetes (direccion, destinatario, lat_dest, lng_dest, estado, agente_id) VALUES (%s, %s, %s, %s, 'pendiente', %s)", paquetes_demo)
        conn.commit()
        
        return {"status": "ok", "message": "Usuario creado"}
    except mysql.connector.Error as err:
        raise HTTPException(status_code=400, detail=str(err))
    finally:
        conn.close()

@app.post("/login")
def login(data: LoginModel):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM agentes WHERE username = %s", (data.username,))
    user = cursor.fetchone()
    conn.close()
    
    if not user:
        raise HTTPException(status_code=401, detail="Usuario no encontrado")
    
    try:
        if not verify_password(data.password, user['password']):
            raise HTTPException(status_code=401, detail="Contraseña incorrecta")
    except ValueError:
        raise HTTPException(status_code=500, detail="Error de formato en contraseña.")
        
    return {"status": "ok", "user_id": user['id'], "nombre": user['nombre']}

@app.get("/paquetes/{agente_id}")
def get_paquetes(agente_id: int):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM paquetes WHERE agente_id = %s AND estado = 'pendiente'", (agente_id,))
    paquetes = cursor.fetchall()
    conn.close()
    return paquetes

@app.post("/entregar")
async def entregar_paquete(
    id_paquete: int = Form(...),
    latitud: str = Form(...),
    longitud: str = Form(...),
    file: UploadFile = File(...)
):
    file_location = f"evidencias/{id_paquete}_{file.filename}"
    with open(file_location, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)
    
    conn = get_db_connection()
    cursor = conn.cursor()
    sql = "UPDATE paquetes SET estado='entregado', evidencia_foto=%s, latitud_entrega=%s, longitud_entrega=%s, fecha_entrega=%s WHERE id=%s"
    cursor.execute(sql, (file_location, latitud, longitud, datetime.now(), id_paquete))
    conn.commit()
    conn.close()
    return {"status": "Entrega registrada"}